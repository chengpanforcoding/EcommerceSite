
@{
    ViewData["Title"] = "立即訂購";
}

<link rel="stylesheet" href="/css/purchase.css" type="text/css">

<section id="bookingNow">
    <div>
        <!--麵包屑-->
        <div class="container mt-3">
            <nav style="--bs-breadcrumb-divider: '>';" aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="javascript:void(0);">付款</a></li>
                    <li class="breadcrumb-item active" aria-current="page">訂購完成</li>
                </ol>
            </nav>
        </div>
        <!--訂購頁本體-->
        <main class="mb-5">
            @*<form action="/Bank/SpgatewayPayBill" method="post">*@
            <div class="container">
                <!--訂購人資料-->
                <div class="board mb-5">
                    <!--訂購標題-->
                    <div class="board-title d-flex gap-3">
                        <div>
                            <a class="text-black" data-bs-toggle="collapse" href="#collapseOrderData" role="button">
                                <span class="fs-3">
                                    <i class="fas fa-angle-down"></i>
                                </span>
                            </a>
                        </div>
                        <div>
                            <span class="fs-5 fw-bold">訂購人資料</span>
                        </div>
                    </div>
                    <div class="container collapse" id="collapseOrderData">
                        <hr class="text-muted">
                        <div class="container ">
                            <!--姓名-->
                            <div class="row mb-3">
                                <div class="col">
                                    <div class="mb-1">
                                        <label>
                                            <span>
                                                名字
                                            </span>
                                            <span class="text-danger">*</span>
                                        </label>
                                    </div>
                                    <div>
                                        <input type="text" name="FirstName" placeholder="例：子庭" class="form-control" v-model="firstName">
                                    </div>
                                </div>
                                <div class="col">
                                    <div class="mb-1">
                                        <label>
                                            <span>
                                                姓氏
                                            </span>
                                            <span class="text-danger">*</span>
                                        </label>
                                    </div>
                                    <div>
                                        <input type="text" name="LastName" placeholder="例：蘇" class="form-control" v-model="lastName">
                                    </div>
                                </div>
                            </div>
                            <!--連絡電話-->
                            <div class="row mb-3">
                                <div class="mb-1">
                                    <label>
                                        <span>
                                            聯絡電話
                                        </span>
                                        <span class="text-danger">*</span>
                                    </label>
                                </div>
                                <div>
                                    <input class="form-control" name="Phone" type="tel" placeholder="請輸入聯絡電話" v-model="buyNowOrderInfo.phone">
                                </div>
                            </div>
                            <!--電子郵件信箱-->
                            <div class="row mb-3">
                                <div class="mb-1">
                                    <label>
                                        <span>
                                            電子郵件信箱
                                            <span class="text-danger">*</span>
                                        </span>
                                    </label>
                                </div>
                                <div>
                                    <input class="form-control" name="Email" type="email" placeholder="請輸入常用電子郵件信箱" v-model="buyNowOrderInfo.email">
                                </div>
                            </div>
                        </div>
                        <button class="btn btn-info mt-3" type="button">繼續</button>
                    </div>
                </div>

                <!--其他資訊-->
                <span class="fs-5 fw-bold">其他資訊</span>
                <div class="board mb-5">
                    <!--商品單項標題-->
                    <div class="board-title d-flex gap-3">
                        <!--icon-->
                        <div>
                            <a class="text-black" data-bs-toggle="collapse" href="#collapseOrderInfo" role="button">
                                <span class="fs-3">
                                    <i class="fas fa-angle-down"></i>
                                </span>
                            </a>
                        </div>
                        <!--商品單項-->
                        <div class="mb-3">
                            <div class="row g-0">
                                <div class="col-3">
                                    <div class="product-pic w-80 h-50">
                                        <img :src="productData.productPictures[0].url"
                                             class="w-100 img-fluid rounded-start product-pic">
                                    </div>
                                </div>
                                <div class="col-9">
                                    <div class="card-body">
                                        <!--商品標題-->
                                        <div class="d-flex">
                                            <span class="card-title mb-3 fs-6 fw-bold">{{productData.title}}</span>
                                        </div>
                                        <div class="d-flex justify-content-between">
                                            <!--日期-->
                                            <div class="d-flex gap-1">
                                                <span class="text-muted"><i class="bi bi-calendar"></i></span>
                                                <p><small class="text-muted">{{productData.goTouristTime}}</small></p>
                                            </div>
                                            <!--人數/商品數-->
                                            <div class="d-flex gap-1">
                                                <span class="text-muted"><i class="bi bi-people-fill"></i></span>
                                                <p><small class="text-muted">數量x{{buyNowOrderInfo.quantity}}</small></p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="container collapse" id="collapseOrderInfo">
                        <hr class="text-muted">
                        <!--特殊需求備註-->
                        <div class="mb-4 mt-4">
                            <div class="mb-2">
                                <span class="fs-6 fw-bold">▎特殊需求備註</span>
                            </div>
                            <div>
                                <textarea class="form-control" placeholder="此欄位僅限資料備註。不在商品規換內的個人需求，不保證提供。"></textarea>
                            </div>
                        </div>
                        <!--使用折扣券-->
                        <div class="mb-3">
                            <div class="mb-2">
                                <span class="fs-6 fw-bold">▎使用折扣券</span>
                            </div>
                            <div class="mt-3 mb-4">
                                <button type="button" class="btn btn-outline-success">
                                    <span>
                                        <i class="bi bi-ticket-perforated"></i>
                                        使用折扣券
                                    </span>
                                </button>
                            </div>
                        </div>
                        <button class="btn btn-info" type="button">繼續</button>
                    </div>
                </div>



                <!--付款方式-->
                <span class="fs-5 fw-bold">付款</span>
                <div class="board mb-5">
                    <!--付款標題-->
                    <div class="board-title d-flex gap-3">
                        <div>
                            <a class="text-black" data-bs-toggle="collapse" href="#collapsePayment" role="button">
                                <span class="fs-3">
                                    <i class="fas fa-angle-down"></i>
                                </span>
                            </a>
                        </div>
                        <div>
                            <span class="fs-5 fw-bold">請選擇付款方式</span>
                        </div>
                    </div>
                    <div class="container collapse" id="collapsePayment">
                        <hr class="text-muted">
                        <!--多種付款方式-->
                        <div class="mb-3">
                            <!--WEBATM繳費-->
                            <!--<div class="form-check">
                                <input class="form-check-input" type="radio" name="PayMethod" id="WEBATM" value="WEBATM">
                                <label class="form-check-label" for="WEBATM">
                                    <div class="d-flex gap-3">
                                        <div>
                                            <span>
                                                網銀繳費
                                            </span>
                                        </div>
                                        <div>
                                            <img src="" style="max-width:40px">
                                        </div>
                                    </div>
                                </label>
                            </div>
                            <hr class="text-muted">-->
                            <!--ATM轉帳-->
                            <!--<div class="form-check">
                                <input class="form-check-input" type="radio" name="PayMethod" id="VACC" value="VACC">
                                <label class="form-check-label" for="VACC">
                                    <div class="d-flex gap-3">
                                        <div>
                                            <span>
                                                ATM轉帳
                                            </span>
                                        </div>
                                        <div>
                                            <img src="" style="max-width:40px">
                                        </div>
                                    </div>
                                </label>
                            </div>
                            <hr class="text-muted">-->
                            <!--超商代碼繳費-->
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="PayMethod" id="CVS" v-model="buyNowOrderInfo.payMethod" value="CVS">
                                <label class="form-check-label" for="CVS">
                                    <div class="d-flex gap-3">
                                        <div>
                                            <span>
                                                超商代碼繳費
                                            </span>
                                        </div>
                                        <div>
                                            <img src="" style="max-width:40px">
                                        </div>
                                    </div>
                                </label>
                            </div>
                            <hr class="text-muted">
                            <!--超商條碼繳費-->
                            <!--<div class="form-check">
                                <input class="form-check-input" type="radio" name="PayMethod" id="BARCODE" value="BARCODE">
                                <label class="form-check-label" for="BARCODE">
                                    <div class="d-flex gap-3">
                                        <div>
                                            <span>
                                                超商條碼繳費
                                            </span>
                                        </div>
                                        <div>
                                            <img src="" style="max-width:40px">
                                        </div>
                                    </div>
                                </label>
                            </div>
                            <hr class="text-muted">-->
                            <!--Google Pay-->
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="PayMethod" id="GooglePay" v-model="buyNowOrderInfo.payMethod" value="GooglePay">
                                <label class="form-check-label" for="GooglePay">
                                    <div class="d-flex gap-3">
                                        <div>
                                            <span>
                                                Google Pay
                                            </span>
                                        </div>
                                        <div>
                                            <img src="https://seeklogo.com/images/G/google-pay-logo-AA826E728D-seeklogo.com.png" style="max-width:40px">
                                        </div>
                                    </div>
                                </label>
                            </div>
                            <hr class="text-muted">
                            <!--Samsung Pay-->
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="PayMethod" id="SamsungPay" v-model="buyNowOrderInfo.payMethod" value="SamsungPay">
                                <label class="form-check-label" for="SamsungPay">
                                    <div class="d-flex gap-3">
                                        <div>
                                            <span>
                                                Samsung Pay
                                            </span>
                                        </div>
                                        <div>
                                            <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/0/07/Samsung_Pay_Logo.svg/462px-Samsung_Pay_Logo.svg.png" style="max-width:100px">
                                        </div>
                                    </div>
                                </label>
                            </div>
                            <hr class="text-muted">
                            <!--信用卡-->
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="PayMethod" id="creditcard"
                                       v-model="buyNowOrderInfo.payMethod" value="creditcard">
                                <label class="form-check-label gap-3" for="creditcard">
                                    <span>
                                        信用卡/簽帳金融卡
                                    </span>
                                    <img src="https://cdn.kkday.com/pc-web/assets/img/payment/ic_visa.svg" alt="">
                                    <img src="https://cdn.kkday.com/pc-web/assets/img/payment/ic_master.svg" alt="">
                                    <img src="https://cdn.kkday.com/pc-web/assets/img/payment/ic_jcb.svg" alt="">
                                </label>
                            </div>
                            <hr class="text-muted">
                        </div>
                        <div class="d-flex gap-1 text-muted">
                            <i class="bi bi-exclamation-circle-fill"></i>
                            <small>
                                付款提醒：本店一律採電子發票寄送到信箱；請注意本平台不會向您收取任何平台交易手續費，但你下單時使用的信用卡或第三方支付平台可能會向您收取相關手續費，請參考其相關服務政策和規定，並向你所選的交易服務商取得更多資訊。
                            </small>
                        </div>
                    </div>

                </div>

                <!--付款明細-->
                <div class="board">
                    <!--付款明細標題-->
                    <div class="board-title d-flex gap-3">
                        <div>
                            <a class="text-black" href="#collapsePayDetail" data-bs-toggle="collapse" role="button">
                                <span class="fs-3">
                                    <i class="fas fa-angle-down"></i>
                                </span>
                            </a>
                        </div>
                        <div>
                            <span class="fs-5 fw-bold">付款明細</span>
                        </div>
                    </div>
                    <div class="container collapse" id="collapsePayDetail">
                        <hr class="text-muted">
                        <!--商品明細-->
                        <div class="container">
                            <!--商品單項-->
                            <div class="mb-3">
                                <div class="mb-3">
                                    <div class="row g-0">
                                        <div class="col-3">
                                            <div class="product-pic w-80 h-50">
                                                <img :src="productData.productPictures[0].url"
                                                     class="w-100 img-fluid rounded-start product-pic" alt="...">
                                            </div>
                                        </div>
                                        <div class="col-9">
                                            <div class="card-body">
                                                <!--商品標題-->
                                                <div class="d-flex">
                                                    <span class="card-title mb-3 fs-6 fw-bold">{{productData.title}}</span>
                                                </div>
                                                <!--日期-->
                                                <div class="d-flex gap-1">
                                                    <span class="text-muted"><i class="bi bi-calendar"></i></span>
                                                    <p><small class="text-muted">{{productData.goTouristTime}}</small></p>
                                                </div>
                                                <!--商品數量-->
                                                <div class="d-flex justify-content-between">
                                                    <span class="text-muted">
                                                        商品數量*{{buyNowOrderInfo.quantity}}
                                                    </span>
                                                    <span class="text-muted">
                                                        TWD {{productData.price*buyNowOrderInfo.quantity}}
                                                    </span>
                                                </div>
                                                <hr class="text-muted">
                                                <!--總金額-->
                                                <div class="d-flex justify-content-between">
                                                    <span class="">
                                                        總金額
                                                    </span>
                                                    <span class="">
                                                        TWD {{productData.price*buyNowOrderInfo.quantity}}
                                                    </span>
                                                </div>
                                            </div>
                                        </div>
                                        <hr class="text-muted">
                                    </div>
                                </div>
                            </div>
                            <!--支付金額-->
                            <div class="d-flex justify-content-between">
                                <p class="fw-bold">支付金額</p>
                                <span class="fw-bold text-info fs-5">TWD {{productData.price*buyNowOrderInfo.quantity}}</span>
                            </div>
                            <hr class="text-muted">
                            <!--訂單回饋 -->
                            <div class="d-flex justify-content-between">
                                <p class="fw-bold">訂單完成後回饋</p>
                                <div class="d-flex text-warning">
                                    <span>
                                        <i class="bi bi-exclamation-circle-fill"></i>
                                        {{points}}
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!--確認付款-->
                <div class="board">
                    <div class="container ">
                        <div class="d-flex justify-content-end">
                            <!--總金額與點數-->
                            <div class="item">
                                <div class="d-flex gap-1 align-items-center">
                                    <small class="text-muted">1件商品合計</small>
                                    <span class="fw-bold text-info">TWD {{productData.price*buyNowOrderInfo.quantity}}</span>
                                </div>
                                <div class="d-flex gap-1 align-items-center justify-content-end">
                                    <small class="text-muted">訂單完成後回饋</small>
                                    <div class="d-flex text-warning">
                                        <span>
                                            <i class="bi bi-exclamation-circle-fill"></i>
                                            {{points}}
                                        </span>
                                    </div>
                                </div>
                            </div>
                            <!--下訂-->
                            <div class="item btn">
                                <div class="d-flex justify-content-end gap-3">
                                    <button class="btn btn-info" v-on:click="addOrder">確認付款</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
            @*</form>*@
        </main>
    </div>
</section>


<script>
    var url = window.location.search;
    console.log("我是網址" + url);
    //?productId=7d2edc71-28ef-48e5-86c7-217999da3de1&quantity=1
    var pid = "";
    var qty = 1;

    if (url.indexOf('?') != -1) {
        //在此直接將各自的參數資料切割放進ary中
        var ary = url.split('?')[1].split('&');
        //此時ary的內容為：
        //ary[0] = 'id=U001'，ary[1] = 'name=GQSM'

        //下迴圈去搜尋每個資料參數
        for (i = 0; i <= ary.length - 1; i++) {
            //如果資料名稱為id的話那就把他取出來
            if (ary[i].split('=')[0] == 'productId') {
                pid = ary[i].split('=')[1];
                console.log(pid);
            } else {
                qty = ary[i].split('=')[1];
                console.log(qty);
            }
        }

    }

    var buyNow = new Vue({
        el: '#bookingNow',
        data: {
            buyNowOrderInfo: {
                productId: pid,
                quantity: qty,
                name: "",
                email: "",
                phone: "",
                payMethod: ""
            },
            productData: {},
            checkOrderInfo: {
                orderNumber: "",
                amount: "",
                payMethod: ""
            },
            lastName: "",
            firstName: ""
        },
        beforeMount: function () {
            let self = this;
            axios.get("/api/products/" + pid)
                .then(function (res) {
                    self.productData = res.data;
                }).catch(function (err) {

                })
        },
        computed: {
            points: function () {
                return Math.floor(this.productData.price * this.buyNowOrderInfo.quantity * 0.1);
            }

        },
        mounted: function () {
            this.getUserData();
        },
        methods: {
            name: function () {
                return this.buyNowOrderInfo.name = this.lastName + this.firstName;
            },
            addOrder: function () {
                let self = this;
                this.name();
                axios.post("/api/Orders/addorder", self.buyNowOrderInfo)
                    .then(function (res) {
                        if (res.status == 200) {
                            self.checkOrderInfo = res.data;
                            axios.post("/api/Orders/PayBill", self.checkOrderInfo)
                                .then(function(res2){
                                    if(res2.status == 200){
                                        alertSuccess("訂購成功，您的訂單號為：" + res2.data.order_number);
                                    }
                                })
                        }
                    });
                //.then(function (res) {
                //    //if (res.status == 204) {
                //    //    //alert("訂購成功");
                //    //    //window.location.href = "/Order/Manage";
                //    //}
                //}).catch(function (err) {
                //    console.log(err.data);
                //});
                //axios.post("/Bank/SpgatewayPayBill", {
                //    ordernumber: "1",
                //    amount: 400,
                //    payMethod: "creditcard"
                //});
            },
            getUserData: function () {
                let self = this;
                axios.get("/auth/getUser").then(
                    function (res) {
                        self.buyNowOrderInfo.email = res.data.account;
                        self.buyNowOrderInfo.phone = res.data.phone;
                        self.lastName = res.data.lastName;
                        self.firstName = res.data.firstName;
                    }
                )
            }
            //getProductData: function () {
            //    let self = this;
            //    axios.get("/api/products/" + pid)
            //        .then(function (res) {
            //            console.log(pid);
            //            self.productData = res.data;
            //            console.log("我是res.data"+res.data);
            //            console.log("我是productData" + self.productData);
            //        }).catch(function (err) {

            //        })
            //}
        }
    })
</script>

